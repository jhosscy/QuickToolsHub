<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Herramientas Digitales</title>
  <style>
    :root {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #f5f5f5;
      --accent-color: #444444;
      --highlight-color: #666666;
      --success-color: #4CAF50;
      --error-color: #f44336;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      margin: 0 auto;
    }

    header {
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      padding: 1rem 1rem;
      margin-bottom: 3rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      z-index: 100;
      width: 100%;
    }

    nav {
      display: flex;
      flex-direction: column-reverse;
      row-gap: 1rem;
      width: 100%;
    }

    h1 {
      font-size: 1.4rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .home-link {
      color: var(--text-color);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .home-link:hover {
      color: var(--highlight-color);
    }

    main {
      margin-bottom: 30px;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .icon {
      display: inline-block;
      stroke-width: 0;
      stroke: currentColor;
      fill: currentColor;
    }

    .scanner-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 60rem;
      padding: 0 1rem;
      margin: 0 auto;
    }

    .input-section {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: var(--transition);
      width: 100%;
    }

    .preview-section {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .file-input-wrapper {
      position: relative;
      width: 100%;
      height: 60px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      height: 100%;
      background-color: var(--accent-color);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-label:hover {
      background-color: var(--highlight-color);
    }

    .file-input-label:active {
      transform: scale(0.98);
    }

    #file-input {
      position: absolute;
      width: 0;
      height: 0;
      opacity: 0;
    }

    .result-container {
      padding: 15px;
      border-radius: 8px;
      background-color: var(--accent-color);
      margin-top: 15px;
      word-break: break-all;
      width: 100%;
      transition: var(--transition);
    }

    .result-container.success {
      background-color: rgba(76, 175, 80, 0.2);
      border-left: 4px solid var(--success-color);
    }

    .result-container.error {
      background-color: rgba(244, 67, 54, 0.2);
      border-left: 4px solid var(--error-color);
    }

    .result-url {
      margin-top: 10px;
      padding: 5px 0;
      color: #2196F3;
      text-decoration: underline;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .result-url:hover {
      color: #64B5F6;
    }

    .preview-container {
      width: 100%;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      border-radius: 8px;
      background-color: var(--accent-color);
    }

    #preview-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #preview-image.loaded {
      opacity: 1;
    }

    .preview-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--text-color);
      opacity: 0.7;
    }

    .loading-spinner {
      display: none;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--text-color);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      text-align: center;
      font-weight: 500;
      font-size: 1rem;
      margin-top: 10px;
      min-height: 24px;
    }

    /* Responsive adjustments */
    @media (min-width: 450px) {
      header {
        padding: 1rem 2rem;
      }
      nav {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .scanner-container {
        padding: 0 2rem;
      }
    }

    /* Responsive layout */
    @media (min-width: 768px) {
      .scanner-container {
        flex-direction: row;
      }

      .input-section {
        width: 50%;
      }

      .preview-section {
        width: 50%;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/" class="home-link">
        <svg class="icon" width="24" height="24" viewBox="0 0 24 24">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        Inicio
      </a>
      <h1>
        <svg class="icon" width="24" height="24" viewBox="0 0 24 24">
          <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h-2v2h-2v2h2v2h2v-2h2v-2h-2v-2zm-1-6h4v4h-4V5zm-2 12h-4v-4h4v4z"/>
        </svg>
        QR Scanner
      </h1>
    </nav>
  </header>

  <main>
    <div class="scanner-container">
      <section class="input-section">
        <div class="file-input-wrapper">
          <label for="file-input" class="file-input-label">
            <svg class="icon" width="24" height="24" viewBox="0 0 24 24">
              <path d="M19 7v3h-2V7h-3V5h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/>
            </svg>
            Seleccionar imagen QR
          </label>
          <input type="file" id="file-input" accept="image/*">
        </div>

        <div class="result-container" id="result-container">
          <div id="result-text">Selecciona una imagen con un código QR para escanear</div>
          <div id="url-container" style="display: none;">
            <a id="result-url" class="result-url" href="#" target="_blank">
              <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                <path d="M19 19H5V5h7V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zm-7-6h4V5h-4v2h2v1h-1v2h1v1h-2v2z"/>
                <path d="M15 1h6v6h-2V4.41L10.41 13 9 11.59 17.59 3H15z"/>
              </svg>
              <span id="url-text"></span>
            </a>
          </div>
        </div>

        <div class="status-message" id="status-message"></div>
      </section>

      <section class="preview-section">
        <h2>Vista previa</h2>
        <div class="preview-container">
          <div class="preview-placeholder" id="preview-placeholder">
            <svg class="icon" viewBox="0 0 24 24" style="width: 48px; height: 48px;">
              <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span>Sin imagen</span>
          </div>
          <div class="loading-spinner" id="loading-spinner"></div>
          <img id="preview-image" alt="Vista previa de la imagen">
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    // Importamos el módulo QrScanner desde el archivo local 'qr-scanner.min.js'
    import QrScanner from './public/qr-scanner.min.js';
    
    // Obtenemos referencias a los elementos del DOM
    const fileInput = document.getElementById('file-input');
    const resultContainer = document.getElementById('result-container');
    const resultText = document.getElementById('result-text');
    const urlContainer = document.getElementById('url-container');
    const resultUrl = document.getElementById('result-url');
    const urlText = document.getElementById('url-text');
    const previewImage = document.getElementById('preview-image');
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const loadingSpinner = document.getElementById('loading-spinner');
    const statusMessage = document.getElementById('status-message');
    
    // Función para actualizar el estado de la UI
    function updateStatus(message, type = '') {
      statusMessage.textContent = message;
      
      // Resetear clases
      resultContainer.classList.remove('success', 'error');
      
      if (type) {
        resultContainer.classList.add(type);
      }
    }
    
    // Función para verificar si un texto es una URL válida
    function isValidUrl(text) {
      try {
        new URL(text);
        return true;
      } catch {
        return false;
      }
    }
    
    // Función para mostrar la imagen seleccionada
    function displayImage(file) {
      previewPlaceholder.style.display = 'none';
      loadingSpinner.style.display = 'block';
      
      const imageUrl = URL.createObjectURL(file);
      
      previewImage.onload = () => {
        loadingSpinner.style.display = 'none';
        previewImage.classList.add('loaded');
      };
      
      previewImage.src = imageUrl;
    }
    
    // Función para resetear la interfaz
    function resetUI() {
      previewImage.classList.remove('loaded');
      previewImage.src = '';
      previewPlaceholder.style.display = 'flex';
      resultContainer.classList.remove('success', 'error');
      resultText.textContent = 'Selecciona una imagen con un código QR para escanear';
      urlContainer.style.display = 'none';
      updateStatus('');
    }
    
    // Agregamos un listener para el evento 'change' en el input de archivo
    fileInput.addEventListener('change', async (event) => {
      // Obtenemos el primer archivo seleccionado
      const selectedFile = event.target.files[0];
      
      // Si no se seleccionó ningún archivo, salimos de la función
      if (!selectedFile) {
        resetUI();
        return;
      }
      
      // Mostrar la imagen seleccionada
      displayImage(selectedFile);
      
      // Actualizar el estado
      updateStatus('Procesando imagen...');
      
      // Crear un bitmap de la imagen redimensionado
      try {
        const resizedImageBitmap = await createImageBitmap(selectedFile, {
          resizeWidth: 300,
          resizeHeight: 300,
          resizeQuality: 'high'
        });
        
        // Escaneamos la imagen redimensionada en busca de un código QR
        try {
          const qrResult = await QrScanner.scanImage(resizedImageBitmap);
          
          // Si se detecta un código QR, mostramos el resultado
          resultText.textContent = qrResult;
          updateStatus('¡Código QR detectado!', 'success');
          
          // Si el resultado es una URL, creamos un enlace clickeable
          if (isValidUrl(qrResult)) {
            urlText.textContent = qrResult;
            resultUrl.href = qrResult;
            urlContainer.style.display = 'block';
          } else {
            urlContainer.style.display = 'none';
          }
        } catch (error) {
          // Si hay un error al escanear el código QR, mostramos un mensaje de error
          resultText.textContent = 'No se pudo detectar un código QR en la imagen.';
          updateStatus('Error al escanear QR', 'error');
          urlContainer.style.display = 'none';
        }
      } catch (error) {
        // Si hay un error al procesar la imagen, mostramos un mensaje de error
        resultText.textContent = 'Error al procesar la imagen.';
        updateStatus('Error al procesar imagen', 'error');
      }
    });
  </script>
</body>
</html>
